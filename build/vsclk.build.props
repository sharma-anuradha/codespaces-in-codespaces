<Project>

  <PropertyGroup>
    <GitRoot>$([MSBuild]::GetDirectoryNameOfFileAbove($(MSBuildThisFileDirectory), '.gitignore'))\</GitRoot>
    <SourceRoot>$(GitRoot)src\</SourceRoot>
    <BuildScriptsDir>$(GitRoot)build\</BuildScriptsDir>
    <Configuration Condition="'$(Configuration)'==''">Debug</Configuration>
    <BaseOutputPath>$(GitRoot)bin\$(Configuration.ToLowerInvariant())\</BaseOutputPath>
    <OutputPath>$(BaseOutputPath)$(MSBuildProjectName)\</OutputPath>
    <PackageOutputPath>$(BaseOutputPath)nupkgs\</PackageOutputPath>
    <AppendTargetFrameworkToOutputPath>false</AppendTargetFrameworkToOutputPath>
    <BaseIntermediateOutputPath>$(GitRoot)bin\obj\$(MSBuildProjectName)\</BaseIntermediateOutputPath>
    <IsTraversal Condition="'$(MSBuildProjectFile)'=='dirs.proj'">true</IsTraversal>
    <RootName Condition="'$(RootName)'==''">Microsoft.VsCloudKernel.Services</RootName>
    <AssemblyName Condition="'$(AssemblyName)'==''">$(RootName).$(MSBuildProjectName)</AssemblyName>
    <RootNamespace Condition="'$(RootNamespace)'==''">$(RootName).$(MSBuildProjectName)</RootNamespace>
  </PropertyGroup>
  
  <!-- Compiler options -->
  <PropertyGroup>
    <Deterministic>true</Deterministic>
  </PropertyGroup>

  <!-- .Net Targets -->
  <PropertyGroup>
    <NetCoreAppTargetFramework>netcoreapp2.2</NetCoreAppTargetFramework>
    <NetStandardTargetFramework>netstandard2.0</NetStandardTargetFramework>
  </PropertyGroup>

  <!-- Package Reference Definitions -->
  <ItemGroup>
    <!-- Design-time packages -->
    <MicroBuildCorePackageReference Include="MicroBuild.Core" Version="0.3.0" PrivateAssets="All" ExcludeAssets="Runtime" />
  </ItemGroup>
  
  <!-- NuGet Package Versions -->
  <PropertyGroup>
    <AdalVersion>4.5.1</AdalVersion>
    <AspNetCoreAppVersion>2.2.3</AspNetCoreAppVersion>
    <AspNetCoreDllVersions>2.2.0</AspNetCoreDllVersions>
    <AzureContainersToolsVersion>1.4.10</AzureContainersToolsVersion>
    <IdentityClient>3.0.0-preview</IdentityClient>
    <IdentityModelS2SVersion>3.0.0-preview-60213030153</IdentityModelS2SVersion>
    <IdentiyModelVersion>6.0.0-preview-60212030309</IdentiyModelVersion>
    <NerdBankGitVersioningVersion>2.3.38</NerdBankGitVersioningVersion>
    <NewtonsoftJsonVersion>12.0.1</NewtonsoftJsonVersion>
    <OctokitVersion>0.32.0</OctokitVersion>
    <StyleCopAnalyzersPackageVersion>1.1.118</StyleCopAnalyzersPackageVersion>
    <SwashbuckleAspNetCorePackageVersion>4.0.1</SwashbuckleAspNetCorePackageVersion>
    <VisualStudioValidationVersion>15.3.58</VisualStudioValidationVersion>
    <VsclkSdkVersion>0.1.16</VsclkSdkVersion> <!-- used under src/services-->
    <VsSaaSPackageVersion>0.1.28</VsSaaSPackageVersion> <!-- preferred for new projects-->
  </PropertyGroup>

  <!-- StyleCop -->
  <Choose>
    <When Condition="'$(UseStyleCop)'=='true'">
      <ItemGroup>
        <AdditionalFiles Include="$(MSBuildThisFileDirectory)stylecop.json" />
        <Content Remove="$(MSBuildThisFileDirectory)stylecop.json" />
        <PackageReference Include="StyleCop.Analyzers" Version="$(StyleCopAnalyzersPackageVersion)">
          <PrivateAssets>all</PrivateAssets>
          <IncludeAssets>runtime; build; native; contentfiles; analyzers; buildtransitive</IncludeAssets>
        </PackageReference>
      </ItemGroup>
    </When>
  </Choose>

  <!-- Code Analysis -->
  <Choose>
    <When Condition="'$(UseCodeAnalysis)'=='true'">
      <PropertyGroup>
        <CodeAnalysisRuleSet Condition="'$(CodeAnalysisRuleSet)'==''">$(MSBuildThisFileDirectory)CodeAnalysis.ruleset</CodeAnalysisRuleSet>
      </PropertyGroup>
    </When>
  </Choose>

  <Choose>
    <When Condition="'$(IsTraversal)'!='true'">
      <!-- Common Package Refs -->
      <ItemGroup>
        <PackageReference Include="Microsoft.VisualStudio.Validation" Version="$(VisualStudioValidationVersion)" />
      </ItemGroup>
      <!-- Versioning Support -->
      <ItemGroup Condition="'$(IsTraversal)'!='true'">
        <PackageReference Include="Nerdbank.GitVersioning" Version="$(NerdBankGitVersioningVersion)" PrivateAssets="All" />
      </ItemGroup>
      <ItemGroup>
        <!-- All projects need to be rebuilt if the version changes. -->
        <Content Include="$(MSBuildThisFileDirectory)version.json" Link="version.json">
          <CopyToOutputDirectory>PreserveNewest</CopyToOutputDirectory>
          <Visible>false</Visible> <!-- Hide from VS solution explorer -->
          <Pack>false</Pack> <!--Exclude from NuGet Packages -->
        </Content>
      </ItemGroup>
    </When>
  </Choose>

  <!-- Microbuild & Signing Support -->
  <ItemGroup>
    <PackageReference Include="@(MicroBuildCorePackageReference)" />
  </ItemGroup>
  
  <!-- Signing Options-->
  <PropertyGroup Condition="'$(IsTestProject)' == 'true'">
    <SkipSigning>true</SkipSigning>
  </PropertyGroup>
  <Choose>
    <When Condition="'$(SkipSigning)' != 'true'">
      <!-- Common signing props-->
      <PropertyGroup>
        <SignAssembly>true</SignAssembly>
        <AssemblyOriginatorKeyFile>$(MSBuildThisFileDirectory)FinalPublicKey.snk</AssemblyOriginatorKeyFile>
      </PropertyGroup>
      <!-- Delay signing -->
      <PropertyGroup Condition="'$(SignType)' != ''">
        <DelaySign>true</DelaySign>
      </PropertyGroup>
      <!-- Public signing -->
      <PropertyGroup Condition="'$(SignType)' == ''">
        <PublicSign>true</PublicSign>
        <PublicKey>0024000004800000940000000602000000240000525341310004000001000100b5fc90e7027f67871e773a8fde8938c81dd402ba65b9201d60593e96c492651e889cc13f1415ebb53fac1131ae0bd333c5ee6021672d9718ea31a8aebd0da0072f25d87dba6fc90ffd598ed4da35e44c398c454307e8e33b8426143daec9f596836f97c8f74750e5975c64e2189f45def46b2a2b1247adc3652bf5c308055da9</PublicKey>
        <PublicKeyToken>31BF3856AD364E35</PublicKeyToken>
      </PropertyGroup>
      <!-- Target to sign -->
      <ItemGroup>
        <FilesToSign Include="$(TargetPath)" Condition=" '$(TargetPath)' != '' " >
          <Authenticode>Microsoft400</Authenticode>
          <StrongName>StrongName</StrongName>
        </FilesToSign>
      </ItemGroup>
    </When>
  </Choose>

</Project>

# For full annotated example, please visit
#   https://onebranch.visualstudio.com/Pipeline/_wiki/wikis/Pipeline.wiki

environment:
  host:
    os: 'windows'
    flavor: 'server'
    version: '2016'
  runtime:
    provider: 'appcontainer'
    image: 'cdpxtest.azurecr.io/global/vse2017u5-external-win14393.1884:1.0'
    source_mode: 'map'

package_sources:
  npm:
    config_files:
      - include:
        - 'src/**/*.npmrc'
        - 'src\**\*.npmrc'
        - 'src\\**\\*.npmrc'
    feeds:                                     # Feeds to inject with credentials in generated .npmrc. Use this if you don't have .npmrc checked in and use a global or team wide configuration.
      registry: https://registry.npmjs.org/    # This is the main registry.

restore:
  commands:
    - !!defaultcommand
      name: 'Update nuget credentials'
      command: '.pipelines\replaceNugetConfig.cmd'
    - !!defaultcommand
      name: 'cdpx-restore'
      command: 'cdpx-restore.cmd'

build:
  commands:
    - !!buildcommand
      name: 'cdpx-build'
      command: 'cdpx-build.cmd'
      artifacts:
        - from: 'bin\release'
          to: 'binaries'
          include:
            - '**/*'

test:
  commands:
    - !!testcommand
      name: 'cdpx-test'
      command: 'cdpx-test.cmd'
      testresults:
       - from: 'bin\release\testresults'
         title: 'Test Results'
         type: 'vstest'
         include:
           - '*.trx'
           - 'coverage\**\*.htm'
           - 'coverage\**\*.csv'
           - 'coverage\**\*.txt'
       - from: 'src\services\containers\VsClk.Portal.WebSite\ClientApp'
         title: 'Portal Test Results'
         type: 'JUnit'
         include:
           - 'junit.xml'

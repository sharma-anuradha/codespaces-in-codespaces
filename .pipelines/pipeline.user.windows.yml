# For full annotated example, please visit
#   https://onebranch.visualstudio.com/Pipeline/_wiki/wikis/Pipeline.wiki?pageId=302

workspace_options:                  # Metadata section
  enable_legacy_networking: true    # Default is false. If false, only the Restore stage enables network connectivity to the user build container. 
                                    # If true, all stages enable network connectivity to user build container.

environment:
  host:
    os: 'windows'                                                       
    flavor: 'server'                                                    
    version: '2016'                                                     
  runtime:
    provider: 'appcontainer'                                            
    image: 'cdpxwin1809.azurecr.io/global/vse2019:latest' 
    source_mode: 'map'                                                  

signing_options:
  profile: 'internal_azure_service'
  codesign_validation_glob_pattern: 'regex|.+(?:dll|exe|sys|ps1|ps1xml|psc1|psd1|cdxml|vbs|wsf)$'

version:
  name: 'PortalExtension'                                    
  major: 1
  minor: 0
  tag: 'alpha'
  system: 'patch'

versioning:
  commands:                                                             

restore:
  commands:
    - !!defaultcommand
      name: 'Update nuget credentials'
      command: '.pipelines\replaceNugetConfig.cmd'
    - !!defaultcommand
      name: 'cdpx-restore'
      command: 'cdpx-restore.cmd'

build:
  commands:                                                             
    - !!buildcommand                                                    
      name: 'Build PortalExtension'                                           
      command: 'src/AzurePortal/build.cmd'                                           
      artifacts:                                                        
        - from: 'src/AzurePortal/src/Default/Extension/bin/Deployment'              
          to: 'src/ServiceGroupRoot'
          include:
            - '**/*'
          signing_options:      # Signing profile defaults can be overridden on the artifacts level
            sign_inline: true   # Sign immediately after this build command so the next build command can package it!

package:
  commands:                                                             

test:
  commands:                                                             

publish:
  commands:                                                             

user_cleanup:
  commands:                                                             

package_sources:
  nuget:
    feeds:
      Nuget.Org: https://api.nuget.org/v3/index.json
    config_files:                               
      - include:                                
        - 'src/AzurePortal/src/NuGet.config'

static_analysis_options:
  binskim_options:
    files_to_scan:
      - from: 'src\AzurePortal\src\Default\Extension\'
        include:
          - '**/*Validation*.dll'
  fxcop_options:
    files_to_scan:
      - from: 'src\AzurePortal\src\Default\Extension\'
        include:
          - '**/*Validation*.dll'
  moderncop_options:
    disable_tool_scan: false
    fail_on_error: true
    files_to_scan:
      - from: 'src\AzurePortal\src\Default\Extension\Client\'          
        include:                         
          - '**/*.ts'
  policheck_options:
    files_to_scan:
      - exclude:
        - 'src/AzurePortal/src/Default/Extension/Client/_extensions/*'
        - 'src/AzurePortal/src/Default/Extension/Client/_generated/*'           
        - 'src/AzurePortal/src/Default/Extension/Client/ReactViews/node_modules/*'
        - 'src/AzurePortal/src/Default/Extension/Output/*'
        - 'src/AzurePortal/src/Default/Extension/ReactDefinitions/*'
        - 'src/AzurePortal/src/Default/Extension/node_modules/*'
        - 'src/AzurePortal/src/Default/Extension/Definitions/*'
        - 'src/AzurePortal/src/Default/Extension/GalleryPackages/*'
        - 'src/Codespaces/*'
        - 'src/Common/*'
        - 'src/Loc/*'
        - 'src/Portal/*'
<Project Sdk="Microsoft.NET.Sdk.Web">

  <PropertyGroup>
    <TargetFramework>$(NetCoreAppTargetFramework)</TargetFramework>
    <AssemblyName>Microsoft.VsCloudKernel.SignalService</AssemblyName>
    <LangVersion>7.1</LangVersion>
    <Timestamp>$([System.DateTime]::Now.ToString("yyyyMMdd.HHmmss"))</Timestamp>
    <IsPublishable>true</IsPublishable>
  </PropertyGroup>

  <ItemGroup>
    <Folder Include="wwwroot\" />
  </ItemGroup>

  <ItemGroup>
    <Compile Include="..\Shared\LoggerScopeHelpers.cs" Link="Shared\LoggerScopeHelpers.cs" />
  </ItemGroup>

  <ItemGroup>
    <!-- Note: remove next package when we move to 3.0 -->
    <PackageReference Include="Microsoft.AspNetCore.App" />
    
    <PackageReference Include="Microsoft.Azure.KeyVault" Version="2.3.2" />
    
    <PackageReference Include="Microsoft.Azure.Management.CosmosDB.Fluent" Version="1.27.0" />
    <PackageReference Include="Microsoft.Azure.Management.Redis.Fluent" Version="1.27.0" />
    <PackageReference Include="Microsoft.Azure.SignalR" Version="1.1.0-preview1-10442" />
    <PackageReference Include="@(MicrosoftVisualStudioValidationPackageReference)" />
    <PackageReference Include="@(NewtonsoftJsonPackageReference)" />
    <PackageReference Include="Microsoft.IdentityModel.Clients.ActiveDirectory" Version="5.2.2" />
    <PackageReference Include="Microsoft.VsSaaS.AspNetCore.TelemetryProvider" Version="0.1.46" />
    <PackageReference Include="Microsoft.VsSaaS.Common" Version="0.1.46" />
    <PackageReference Include="Microsoft.AspNetCore.SignalR.Client" Version="1.1.0" />

    <!-- For .NET Core 3.0+ -->
    <!--<PackageReference Include="Microsoft.AspNetCore.Authentication.JwtBearer" Version="3.0.0" />-->
  </ItemGroup>

  <ItemGroup>
    <ProjectReference Include="..\BackplaneProviders\AzureDocumentsProvider\AzureDocumentsProvider.csproj" />
    <ProjectReference Include="..\BackplaneProviders\AzureRedisProvider\AzureRedisProvider.csproj" />
    <ProjectReference Include="..\PresenceServiceHub\PresenceServiceHub.csproj" />
    <ProjectReference Include="..\RelayServiceHub\RelayServiceHub.csproj" />
  </ItemGroup>

  <ItemGroup>
    <DockerFiles Include="Dockerfile" />
    <DockerFiles Include="docker-compose.yml" />
    <AzureDeployFiles Include="./Deployment/azure*.json" />
  </ItemGroup>
  
  <ItemGroup>
    <Content Update="appsettings.json">
      <CopyToOutputDirectory>PreserveNewest</CopyToOutputDirectory>
    </Content>
    <Content Update="appsettings.Development.json">
      <CopyToOutputDirectory>PreserveNewest</CopyToOutputDirectory>
    </Content>
    <Content Update="appsettings.Debug.json">
      <CopyToOutputDirectory>PreserveNewest</CopyToOutputDirectory>
    </Content>
  </ItemGroup>
  
  <Target Name="GenerateTags" AfterTargets="build">
    <Message Text="GitCommitId: $(GitCommitId) version:$(Version) buildtag:$(Timestamp)" />

    <WriteLinesToFile File="$(Outdir)buildtag.txt" Lines="$(Timestamp)" Overwrite="true" />
    <WriteLinesToFile File="$(Outdir)version.txt" Lines="$(Version)" Overwrite="true" />
    <WriteLinesToFile File="$(Outdir)gitcommitid.txt" Lines="$(GitCommitId)" Overwrite="true" />
  </Target>
  
  <Target Name="CopyDeploymentFiles" AfterTargets="Publish">
    <Copy SourceFiles="@(DockerFiles)" DestinationFolder="$(Outdir)\%(RecursiveDir)" SkipUnchangedFiles="false" />
    <Copy SourceFiles="@(AzureDeployFiles)" DestinationFolder="$(Outdir)\%(RecursiveDir)" SkipUnchangedFiles="false" />
    <ItemGroup>
      <FileWrites Include="$(OutDir)\**\*.*" />
    </ItemGroup>
  </Target>
  
</Project>

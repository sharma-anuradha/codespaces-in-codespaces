<Project Sdk="Microsoft.NET.Sdk.Web">

  <PropertyGroup>
    <TargetFramework>$(NetCoreAppTargetFramework)</TargetFramework>
    <AssemblyName>Microsoft.VsCloudKernel.SignalService</AssemblyName>
    <LangVersion>7.1</LangVersion>
    <Timestamp>$([System.DateTime]::Now.ToString("yyyyMMdd.HHmmss"))</Timestamp>
    <IsPublishable>true</IsPublishable>
  </PropertyGroup>

  <ItemGroup>    
    <PackageReference Include="Microsoft.AspNetCore.Authentication.JwtBearer" Version="$(AspNetCoreDllVersions)" />
    <PackageReference Include="Microsoft.AspNetCore.SignalR.Client" Version="$(AspNetCoreDllVersions)" />
    <PackageReference Include="Microsoft.Azure.KeyVault" Version="2.3.2" />
    <PackageReference Include="Microsoft.Azure.SignalR" Version="$(SignalRVersion)" />
    <PackageReference Include="Microsoft.IdentityModel.Clients.ActiveDirectory" Version="5.2.2" />
    <PackageReference Include="Microsoft.VsSaaS.AspNetCore.TelemetryProvider" Version="$(VsSaaSPackageVersion)" />
    <PackageReference Include="Microsoft.VsSaaS.Common" Version="$(VsSaaSPackageVersion)" />
    <PackageReference Include="StreamJsonRpc" Version="$(StreamJsonRpcVersion)" />
  </ItemGroup>

  <ItemGroup>
    <ProjectReference Include="..\BackplaneProviders\AzureDocumentsProvider.AspNetCore\AzureDocumentsProvider.AspNetCore.csproj" />
    <ProjectReference Include="..\BackplaneProviders\AzureRedisProvider.AspNetCore\AzureRedisProvider.AspNetCore.csproj" />
    <ProjectReference Include="..\BackplaneProviders\ContactBackplane.Common\ContactBackplane.Common.csproj" />
    <ProjectReference Include="..\BackplaneProviders\ContactBackplaneServiceProvider\ContactBackplaneServiceProvider.csproj" />
    <ProjectReference Include="..\Common.AspNetCore\Common.SignalR.AspNetCore.csproj" />
    <ProjectReference Include="..\ContactServiceHub\ContactServiceHub.csproj" />
    <ProjectReference Include="..\RelayServiceHub\RelayServiceHub.csproj" />
  </ItemGroup>

  <ItemGroup>
    <DockerFiles Include="Dockerfile" />
    <DockerFiles Include="docker-compose.yml" />
    <AzureDeployFiles Include="./Deployment/azure*.json" />
  </ItemGroup>
  
  <ItemGroup>
    <Content Update="appsettings.json">
      <CopyToOutputDirectory>PreserveNewest</CopyToOutputDirectory>
    </Content>
    <Content Update="appsettings.Development.json">
      <CopyToOutputDirectory>PreserveNewest</CopyToOutputDirectory>
    </Content>
    <Content Update="appsettings.Debug.json">
      <CopyToOutputDirectory>PreserveNewest</CopyToOutputDirectory>
    </Content>
  </ItemGroup>
  
  <Target Name="GenerateTags" AfterTargets="build">
    <Message Text="GitCommitId: $(GitCommitId) version:$(Version) buildtag:$(Timestamp)" />

    <WriteLinesToFile File="$(Outdir)buildtag.txt" Lines="$(Timestamp)" Overwrite="true" />
    <WriteLinesToFile File="$(Outdir)version.txt" Lines="$(Version)" Overwrite="true" />
    <WriteLinesToFile File="$(Outdir)gitcommitid.txt" Lines="$(GitCommitId)" Overwrite="true" />
  </Target>
  
  <Target Name="CopyDeploymentFiles" AfterTargets="Publish">
    <Copy SourceFiles="@(DockerFiles)" DestinationFolder="$(Outdir)\%(RecursiveDir)" SkipUnchangedFiles="false" />
    <Copy SourceFiles="@(AzureDeployFiles)" DestinationFolder="$(Outdir)\%(RecursiveDir)" SkipUnchangedFiles="false" />
    <ItemGroup>
      <FileWrites Include="$(OutDir)\**\*.*" />
    </ItemGroup>
  </Target>
  
</Project>

// WARNING: AUTO GENERATED BY KUSTO COMPILER.
// See vsclk-core repository for details.
// Source File: Events\State\ShuttingDownToShutdownEvents.ksf
// Scoped events for last 7 days and on prod ring.
let ScopedRawEvents = DefaultEvent
    | where ['time'] between (ago(7d) .. now())
    | where ServiceEnvironment == "vsclk-online-prod";
let GetStateTransitionEvents = (fromState: string, toState: string) { 
    ScopedRawEvents
        | where msg == "environmentstatemanager_setenvironmentstateasync"
        | where CloudEnvironmentOldState == fromState and CloudEnvironmentNewState == toState
        | project CloudEnvironmentOldState, CloudEnvironmentNewState, ['time'], WorkspaceId, CloudEnvironmentFailedStateReason, HttpRequestMethod, HttpRequestUri, CorrelationId, CloudEnvironmentId, CloudEnvironmentNewUpdatedTrigger
        | summarize arg_max(['time'], *) by CloudEnvironmentOldState, CloudEnvironmentNewState, WorkspaceId, CorrelationId, CloudEnvironmentId
};
let ShuttingDownToShutdownEvents = GetStateTransitionEvents(fromState="ShuttingDown", toState="Shutdown")
    | extend EventAtShuttingDownToShutdown = 1
    | extend EventAtShuttingDownToShutdown_Time = ['time']
    | extend EventAtShuttingDownToShutdown_UserInitiated = iff(HttpRequestUri startswith "/api/v1/environments/" and HttpRequestUri endswith "/shutdown" and HttpRequestMethod == "POST", 1, 0)
    | extend EventAtShuttingDownToShutdown_UserInitiatedDelete = iff(HttpRequestUri startswith "/api/v1/environments/" and HttpRequestMethod == "DELETE", 1, 0)
    | extend EventAtShuttingDownToShutdown_ViaHeartbeat = iff(HttpRequestUri == "/api/v1/heartbeat" and HttpRequestMethod == "POST", 1, 0)
    | extend EventAtShuttingDownToShutdown_CorrelationId = CorrelationId
    | extend EventAtShuttingDownToShutdown_Forced = iff(CloudEnvironmentNewUpdatedTrigger == "ForceEnvironmentShutdown", 1, 0)
    | extend EventAtShuttingDownToShutdown_WorkspaceId = WorkspaceId
    | project EventAtShuttingDownToShutdown,
        EventAtShuttingDownToShutdown_Time,
        EventAtShuttingDownToShutdown_UserInitiated,
        EventAtShuttingDownToShutdown_UserInitiatedDelete,
        EventAtShuttingDownToShutdown_ViaHeartbeat,
        EventAtShuttingDownToShutdown_CorrelationId,
        EventAtShuttingDownToShutdown_Forced,
        EventAtShuttingDownToShutdown_WorkspaceId;

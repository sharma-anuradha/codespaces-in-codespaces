#include("..\Raw\ScopedRawEvents_7Days.ksf")
// Last Error on a Web Request
let LastErrorInRequestEvents = ScopedRawEvents
    | where level == "error"
    | where CorrelationId != ""
    | extend LastErrorInRequestEvents = 1
    | extend LastErrorInRequestEvents_Time = ["time"]
    | extend LastErrorInRequestEvents_CorrelationId = CorrelationId
    | extend LastErrorInRequestEvents_ErrorException = ErrorException
    | extend LastErrorInRequestEvents_ErrorMessage = ErrorMessage
    | extend LastErrorInRequestEvents_ErrorDetail = ErrorDetail
    | project LastErrorInRequestEvents, 
        LastErrorInRequestEvents_Time, 
        LastErrorInRequestEvents_CorrelationId,
        LastErrorInRequestEvents_ErrorException,
        LastErrorInRequestEvents_ErrorMessage,
        LastErrorInRequestEvents_ErrorDetail
    | summarize arg_max(LastErrorInRequestEvents_Time, *) by LastErrorInRequestEvents_CorrelationId;
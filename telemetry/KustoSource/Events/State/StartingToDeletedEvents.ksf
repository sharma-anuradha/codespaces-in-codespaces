#include("GetStateTransitionEvents.ksf")
let StartingToDeletedEvents = GetStateTransitionEvents(fromState="Starting", toState="Deleted")
    | extend EventAtStartingToDeleted = 1
    | extend EventAtStartingToDeleted_Time = ['time']
    | extend EventAtStartingToDeleted_UserInitated = iff(HttpRequestUri startswith "/api/v1/environments/" and HttpRequestMethod == "DELETE", 1, 0)
    | extend EventAtStartingToDeleted_CorrelationId = CorrelationId
    | extend EventAtStartingToDeleted_WorkspaceId = WorkspaceId
    | project EventAtStartingToDeleted, 
        EventAtStartingToDeleted_Time, 
        EventAtStartingToDeleted_UserInitated, 
        EventAtStartingToDeleted_CorrelationId, 
        EventAtStartingToDeleted_WorkspaceId
    | summarize arg_min(EventAtStartingToDeleted_Time, *) by EventAtStartingToDeleted_CorrelationId;
#include("GetStateTransitionEvents.ksf")
let ProvisioningToShutdownEvents = GetStateTransitionEvents(fromState="Provisioning", toState="Shutdown")
    | extend EventAtProvisioningToShutdown = 1
    | extend EventAtProvisioningToShutdown_Time = ['time']
    | extend EventAtProvisioningToShutdown_UserInitiated = iff(HttpRequestUri startswith "/api/v1/environments/" and HttpRequestUri endswith "/shutdown" and HttpRequestMethod == "POST", 1, 0)
    | extend EventAtProvisioningToShutdown_UserInitiatedDelete = iff(HttpRequestUri startswith "/api/v1/environments/" and HttpRequestMethod == "DELETE", 1, 0)
    | extend EventAtProvisioningToShutdown_CorrelationId = CorrelationId
    | extend EventAtProvisioningToShutdown_WorkspaceId = WorkspaceId
    | project EventAtProvisioningToShutdown, 
        EventAtProvisioningToShutdown_Time, 
        EventAtProvisioningToShutdown_UserInitiated, 
        EventAtProvisioningToShutdown_UserInitiatedDelete, 
        EventAtProvisioningToShutdown_CorrelationId,
        EventAtProvisioningToShutdown_WorkspaceId
    | summarize arg_min(EventAtProvisioningToShutdown_Time, *) by EventAtProvisioningToShutdown_CorrelationId;